#!/bin/bash

print_usage() {
  printf "Usage: ./ipscan.sh [OPTIONS]"
}

pFlag=0
iFlag=0
ip=''
while getopts 'i:p' flag; do
  case "$flag" in
    i) iFlag=1
      ip="$OPTARG"
      ;;
    p) pFlag=1 ;;
    *) print_usage
      exit 1 ;;
  esac
done
readonly iFlag
readonly ip
readonly pFlag

if [ "$1" == '' ]
then
  print_usage

elif [ "$iFlag" == 1 ]
then
  # Create IP directory if it does not yet exist
  if [ ! -d "$ip" ]
  then
    mkdir "$ip"
  fi

  cd "$ip" || exit

  # Output header and conduct nmap scan
  echo -e "\033[31;1;4mSCAN FOR IP: $ip\033[0m\n" | tee 'ipscan.txt'
  if [ $pFlag == 1 ]
  then
    nmap -p- -A -T4 "$ip" -Pn | tee -a 'ipscan.txt'
  else
    nmap -p- -A -T4 "$ip" | tee -a 'ipscan.txt'
  fi

  # Identify lines where 'http' is mentioned on the port & capture the port number
  ports=$(grep ' http ' < 'ipscan.txt' | awk '{print $1}' | cut -d '/' -f 1)
  for port in $ports; do
    # Conduct ffuf fuzz
    echo -e "\n\033[31;1;4mFFUF Scan of port: $port\033[0m" | tee -a 'ipscan.txt'
    ffuf -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt:FUZZ -u "http://$ip:$port/FUZZ" | tee -a 'ipscan.txt'

    # Conduct dirb fuzz
    echo -e "\n\033[31;1;4mDirb Scan of port: $port\033[0m" | tee -a 'ipscan.txt'
    dirb "http://$ip:$port" -o 'dirbfuzz.txt'
    cat 'dirbfuzz.txt' >> 'ipscan.txt'
    done

  # Identify dirb lines where a page was found and extract the url
  files=$(grep '+ http*://' < 'ipscan.txt' | grep 'CODE:200' | tr -d '+' | awk '{print $1}')

  # Screenshot pages with gowitness
  echo -e "\n\033[31;1;4mGowitness:\033[0m"
  for file in $files; do
    gowitness single "$file"
    done
fi
